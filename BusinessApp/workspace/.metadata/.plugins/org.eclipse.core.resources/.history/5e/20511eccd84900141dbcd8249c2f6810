package com.fervil.spring.careercoach.web;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.File;
import java.io.IOException;
import java.net.URLDecoder;
import java.sql.Blob;
import java.util.Date;

import javax.annotation.Resource;
import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.hibernate.Hibernate;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.ui.ModelMap;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.support.SessionStatus;
import org.springframework.web.multipart.MultipartFile;

import ua.com.bitlab.springsecuritydemo.services.UsersManagerServiceImpl;
import ua.com.bitlab.springsecuritydemo.services.security.SecurityUtils;

import com.fervil.spring.careercoach.model.domain.UserProfile;
import com.fervil.spring.careercoach.service.CreateUserProfileValidator;
import com.fervil.spring.careercoach.service.UserProfileManager;
import com.fervil.spring.careercoach.util.Constants;
import com.fervil.spring.careercoach.util.SystemUtil;

@Transactional
@Controller 
@RequestMapping("/createuserprofile") 
public class CreateUserProfileFormController {
	
    private static final Logger log = LoggerFactory.getLogger(CreateUserProfileFormController.class);
	
	@Autowired
	private SessionFactory sessionFactory;

//Testing only
	@Resource(name = "userProfileValidator")
	private CreateUserProfileValidator validator;
	
	@Resource(name = "userProfileManager")
	private UserProfileManager userProfileManager;

	@Autowired
	ServletContext context;	
	
	@RequestMapping(method = RequestMethod.GET) 
	public String printHello(ModelMap model, org.springframework.web.context.request.WebRequest webRequest) {
		try{

			UserProfile userProfile = new UserProfile();

			if (webRequest.getParameter("profileId") == null){
				userProfile.setModifiedDate(new Date());
				userProfile.setAccountType(1);
				userProfile.setUserProfileType(1);
				
				userProfile.setCoachingcategory1(-1);
				userProfile.setCoachingcategory2(-1);
				userProfile.setCoachingcategory3(-1);
				
				userProfile.setIndustryfocus1(-1);
				userProfile.setIndustryfocus2(-1);
				userProfile.setIndustryfocus3(-1);
				
				
			} else{
				userProfile = userProfileManager.findById(Long.valueOf(webRequest.getParameter("profileId")));
			}
			
 			
			model.addAttribute("profileId", webRequest.getParameter("profileId"));
			model.addAttribute("userProfile", userProfile);
			return "userprofile/createuserprofile"; 
			
		} catch (Exception e) {
	        String msg = "The request failed. Error " + e;
	        log.error(msg, e);
			model.addAttribute(Constants.ERROR_MSG_KEY, Constants.ERROR_MSG);
			return "public/common/error/errorpage";
		}	
	} 
	
	@RequestMapping(method = RequestMethod.POST)
	public String submitForm(
			@ModelAttribute("userProfile") UserProfile userProfile,
			@RequestParam("profilePicture") MultipartFile profilePicture, 
			BindingResult result, SessionStatus status, ModelMap model, HttpServletRequest request, HttpServletResponse response,
			org.springframework.web.context.request.WebRequest webRequest) {
		
 		
		validator.validate(userProfile, result);

		try {
		
	        if (result.hasErrors()) {
				return "userprofile/createuserprofile";
			} else {
				long userProfileId = SystemUtil.getUserProfileId(request, userProfileManager);
				if (webRequest.getParameter("profileId") != null && !((String)webRequest.getParameter("profileId")).equals("")  && Long.valueOf((String)webRequest.getParameter("profileId")) > 0){
					userProfile.setUserProfileId(Long.valueOf(webRequest.getParameter("profileId")));
				} else if (userProfileId > 0){
					userProfile.setUserProfileId(userProfileId);
				}

				
				userProfile.setUser_userId(SecurityUtils.getCurrentUser().getId());
				userProfile.setModifiedDate(new Date());
				userProfile.setAccountType(1);
				userProfile.setUserProfileType(1);

				Session session = sessionFactory.getCurrentSession();
				Blob blob = Hibernate.getLobCreator(session).createBlob(profilePicture.getInputStream(), profilePicture.getSize());
				
				if (profilePicture.getBytes().length  > 4096000){
					model.addAttribute(Constants.ERROR_MSG_KEY, "The image selected is bigger than 4,096KB. Please choose a smaller image to proceed.");
					return "userprofile/createuserprofile";
				}
				
				userProfile.setProfilepicture(blob);
				userProfile.setProfile_picture_type(profilePicture.getContentType()); 
				
				userProfileManager.storeUserProfile(userProfile);
				status.setComplete();

				//saveMultipartToDisk(profilePicture, userProfile);
				saveMultipartToAmazonS3(profilePicture, userProfile);

				return "redirect:createuserprofilesuccess/userProfileId/" + userProfile.getUserProfileId();
			    
			}
		} catch (Exception e) {
	            String msg = "Failed to create user. Error " + e;
	            log.error(msg, e);
				model.addAttribute(Constants.ERROR_MSG_KEY, Constants.ERROR_MSG);
				return "userprofile/createuserprofile";
		}
	}

	private String calculateDestinationDirectory(UserProfile userProfile) {
        String result = this.context.getRealPath("");
        //result += "/";
        result += Constants.UPLOAD_DIRECTORY;
        result += "/";
        result += userProfile.getUserProfileId();
        
        return result;
    }
 
    private String calculateDestinationPath(MultipartFile file, UserProfile userProfile) {
        String result = this.calculateDestinationDirectory(userProfile);
        result += "/";
        result += "USERPROFILEIMAGE" + userProfile.getUserProfileId() + "." + getFileExtension(file);
        //result += file.getOriginalFilename();

        return result;
    }
 
    private void saveMultipartToAmazonS3(MultipartFile file, UserProfile userProfile) throws Exception {
        File dir = new File(this.calculateDestinationDirectory(userProfile));
        if(!dir.exists()) {
            dir.mkdirs();
        }
        File multipartFile = new File(this.calculateDestinationPath(file, userProfile));
        file.transferTo(multipartFile);
    }	

    private void saveMultipartToDisk(MultipartFile file, UserProfile userProfile) throws Exception {
        File dir = new File(this.calculateDestinationDirectory(userProfile));
        if(!dir.exists()) {
            dir.mkdirs();
        }
        File multipartFile = new File(this.calculateDestinationPath(file, userProfile));
        file.transferTo(multipartFile);
    }	
    
    
    private String getFileExtension(MultipartFile file ) {
		String filename = file.getOriginalFilename();
		return filename.substring(filename.lastIndexOf( "." ) + 1 );
	}
}
